<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Availability Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <h1>Group Availability Scheduler</h1>
    <div class="flex items-center space-x-4 mb-4">
        <label class="text-lg font-semibold">Other Users:</label>
        <div id="userCheckboxes" class="flex flex-wrap space-x-4"></div>
    </div>
    <div class="flex items-center space-x-4 mb-4">
        <label for="userSelect" class="text-lg font-semibold">Who are you?</label>
        <select id="userSelect" class="border border-gray-300 rounded-md p-2">
            <option value="">Select User</option>
        </select>
        <button id="addUserButton" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add New User</button>
    </div>
    <div id="addUserModal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg">
            <h2>Add New User</h2>
            <input type="text" id="newUserName" placeholder="Enter user name" class="border border-gray-300 rounded-md p-2 mb-4">
            <button id="saveUserButton" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Save</button>
            <button id="cancelUserButton" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 ml-2">Cancel</button>
        </div>
    </div>
    <div class="scheduler grid grid-cols-8 gap-2 w-full max-w-5xl">
        <!-- Headers -->
        <div class="header">Time</div>
        <div class="header">Monday</div>
        <div class="header">Tuesday</div>
        <div class="header">Wednesday</div>
        <div class="header">Thursday</div>
        <div class="header">Friday</div>
        <div class="header">Saturday</div>
        <div class="header">Sunday</div>

        <!-- Timeslots 9AM to 10PM in half-hour increments -->
        <script>
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const timeSlots = [];
            for (let i = 9; i < 22; i++) {
                timeSlots.push(`${i}:00`);
                timeSlots.push(`${i}:30`);
            }
            timeSlots.push("22:00"); // Last slot 10 PM

            const userSelect = document.getElementById("userSelect");
            const addUserButton = document.getElementById("addUserButton");
            const addUserModal = document.getElementById("addUserModal");
            const newUserNameInput = document.getElementById("newUserName");
            const scheduler = document.querySelector(".scheduler");
            const saveUserButton = document.getElementById("saveUserButton");
            const cancelUserButton = document.getElementById("cancelUserButton");

            let users = JSON.parse(localStorage.getItem('users')) || [];
            let scheduleData = JSON.parse(localStorage.getItem('scheduleData')) || {};
            let currentUser = "";
            let activeUsers = new Set();

            function createCell(content, cssClass = "") {
                const cell = document.createElement("div");
                const textElement = document.createElement("span");
                textElement.textContent = content;
                textElement.classList.add("truncate");
                textElement.style.display = "block";
                textElement.style.overflow = "hidden";
                textElement.style.textOverflow = "ellipsis";
                textElement.style.whiteSpace = "nowrap";
                cell.appendChild(textElement);
                cell.classList.add("h-10", "w-full", "flex", "items-center", "justify-center", "text-xs");
                if (cssClass) {
                    cell.classList.add(cssClass);
                }
                return cell;
            }

            function renderScheduler() {
                scheduler.innerHTML = '';
                scheduler.appendChild(createCell("Time", "header"));
                days.forEach(day => scheduler.appendChild(createCell(day, "header")));
                
                timeSlots.forEach(time => {
                    scheduler.appendChild(createCell(time, "header"));
                    days.forEach(day => {
                        const availabilityKey = `${currentUser}-${day}-${time}`;
                        const isCurrentUserAvailable = scheduleData[availabilityKey] === "available";
                        const otherUsersAvailable = [...activeUsers].every(user => scheduleData[`${user}-${day}-${time}`] === "available");
                        const unavailableUsers = [...activeUsers].filter(user => user !== currentUser && scheduleData[`${user}-${day}-${time}`] !== "available");
                        const cellClass = isCurrentUserAvailable
                            ? (otherUsersAvailable ? "bg-green-200" : "bg-gray-200")
                            : "bg-red-200";
                        const cell = createCell(isCurrentUserAvailable && unavailableUsers.length > 0 ? unavailableUsers.join(', ') : "", cellClass);
                        cell.style.display = "flex";
                        cell.style.alignItems = "center";
                        cell.style.justifyContent = "center";
                        cell.style.overflow = "hidden";
                        cell.style.textOverflow = "ellipsis";
                        cell.style.whiteSpace = "nowrap";
                        cell.classList.add("truncate", "flex", "items-center", "justify-center");
                        
                        cell.style.whiteSpace = "nowrap";
                        cell.style.textOverflow = "ellipsis";
                        cell.classList.add("truncate");
                        if (unavailableUsers.length > 0) {
                            if (unavailableUsers.length > 0) {
                            cell.title = unavailableUsers.join(', ');
                        }
                        }
                        cell.addEventListener("click", () => {
                            if (currentUser) {
                                if (cell.classList.contains("bg-green-200")) {
                                    cell.classList.remove("bg-green-200");
                                    cell.classList.add("bg-red-200");
                                    scheduleData[availabilityKey] = "unavailable";
                                } else {
                                    cell.classList.remove("bg-red-200");
                                    cell.classList.add("bg-green-200");
                                    scheduleData[availabilityKey] = "available";
                                }
                                saveSchedule();
                            } else {
                                alert("Please select a user to edit their schedule.");
                            }
                        });
                        scheduler.appendChild(cell);
                    });
                });
            }

            function saveSchedule() {
                localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
            }

            function renderUserSelect() {
                userSelect.innerHTML = '<option value="">Select User</option>';
                users.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    userSelect.appendChild(option);
                });
                renderUserCheckboxes();
            }

            function renderUserCheckboxes() {
                const userCheckboxes = document.getElementById("userCheckboxes");
                userCheckboxes.innerHTML = '';
                users.forEach(user => {
                    const checkboxWrapper = document.createElement("div");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = user;
                    checkbox.checked = activeUsers.has(user);
                    if (user === currentUser) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    }
                    checkbox.addEventListener("change", () => {
                        if (checkbox.checked) {
                            activeUsers.add(user);
                        } else {
                            activeUsers.delete(user);
                        }
                        renderScheduler();
                    });
                    const label = document.createElement("label");
                    label.htmlFor = user;
                    label.textContent = user;
                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.appendChild(label);
                    userCheckboxes.appendChild(checkboxWrapper);
                    }
                );
            }

            function saveUsers() {
                localStorage.setItem('users', JSON.stringify(users));
            }

            userSelect.addEventListener("change", () => {
                currentUser = userSelect.value;
                activeUsers.clear();
                activeUsers.add(currentUser);
                renderUserCheckboxes();
                renderScheduler();
            });

            addUserButton.addEventListener("click", () => {
                addUserModal.classList.remove("hidden");
            });

            saveUserButton.addEventListener("click", () => {
                const newUserName = newUserNameInput.value.trim();
                if (newUserName && !users.includes(newUserName)) {
                    users.push(newUserName);
                    saveUsers();
                    renderUserSelect();
                    newUserNameInput.value = "";
                    addUserModal.classList.add("hidden");
                } else {
                    alert("Invalid or duplicate user name.");
                }
            });

            cancelUserButton.addEventListener("click", () => {
                newUserNameInput.value = "";
                addUserModal.classList.add("hidden");
            });

            // Initial Render
            renderUserSelect();
            renderScheduler();
        </script>
    </div>
</body>
</html>